# 拍拍房 Demo 使用说明

## 🎯 项目概述

这是一个完整的**拍拍房系统 Demo**，展示了**权限中心 + 状态模式 + 角色协作**的架构设计。

## 🏗️ 架构设计

```
┌─────────────────────────────────────────┐
│           PPRoom 系统架构                │
├─────────────────────────────────────────┤
│                                         │
│  UI层 (ViewController)                  │
│    ↓                                    │
│  业务层 (RoomManager)                   │
│    ↓                                    │
│  ┌──────────────┐   ┌───────────────┐ │
│  │ 权限中心      │   │  状态模式      │ │
│  │ Permission   │←→│  State         │ │
│  │ Center       │   │  Pattern       │ │
│  └──────────────┘   └───────────────┘ │
│    ↓                      ↓            │
│  模型层 (Room, User, etc.)             │
│                                         │
└─────────────────────────────────────────┘
```

## 📁 文件结构

```
PPRoom/
├── Models/
│   ├── RoomModels.swift      # 核心模型定义
│   └── Room.swift             # 房间模型
│
├── Permission/
│   └── PermissionCenter.swift # 权限中心（基于规则引擎）
│
├── States/
│   └── RoomStateProtocol.swift # 状态模式（4个状态类）
│
├── Manager/
│   └── RoomManager.swift      # 房间管理器
│
└── ViewController.swift       # Demo UI界面
```

## 🎭 核心组件

### 1. 权限中心 (PermissionCenter)

**职责：** 统一管理所有操作的权限验证

**特点：**
- 基于规则引擎实现
- 支持复杂的权限规则组合
- 每个规则有优先级
- 友好的错误提示

**权限检查流程：**
```
用户操作 → 权限中心 → 规则引擎 → 逐条验证规则 → 允许/拒绝
```

### 2. 状态模式 (State Pattern)

**4个状态：**
- **准备阶段 (Preparing)**: 拍卖人上传物品、设置规则
- **上拍 (Listing)**: 展示物品，倒计时准备
- **拍卖中 (Auctioning)**: 用户出价，实时竞拍
- **定拍 (Closed)**: 拍卖结束，展示成交结果

**状态转换：**
```
准备阶段 → 上拍 → 拍卖中 → 定拍 → (循环)准备阶段
```

### 3. 角色系统

**4个角色：**
- **房主 (Host)**: 创建房间、管理流程、强制结束
- **拍卖人 (Auctioneer)**: 上传物品、语音介绍、不能自己出价
- **竞拍者 (Bidder)**: 出价竞拍、查看信息
- **观众 (Viewer)**: 观看拍卖、无出价权限

## 🎮 Demo 功能

### 界面说明

1. **房间信息区**: 显示房间名称、在线人数、当前状态
2. **拍卖信息区**: 显示拍卖物品、当前价格、领先者
3. **消息区**: 显示房间消息、系统通知、出价记录
4. **操作区**: 各种操作按钮

### 操作按钮

#### 切换用户
- 主持人小王（房主）
- 拍卖人老李（拍卖人）
- 竞拍者张三（竞拍者）
- 竞拍者李四（竞拍者）
- 观众小明（观众）

#### 拍卖操作
- **上传物品**: 拍卖人上传拍卖物品
- **开始拍卖**: 房主开始拍卖流程
- **结束拍卖**: 房主强制结束拍卖

#### 出价操作
- 出价 ¥110
- 出价 ¥150
- 出价 ¥200

### 测试场景

#### 场景1：观众尝试出价（权限拒绝）
测试权限中心是否正确拒绝观众出价。

**预期结果：** ❌ 观众无法出价，请升级为竞拍者

#### 场景2：拍卖人给自己出价（权限拒绝）
测试权限中心是否正确拒绝拍卖人对自己物品出价。

**预期结果：** ❌ 您是拍卖人，不能对自己的物品出价

#### 场景3：完整拍卖流程（自动演示）
自动执行完整的拍卖流程：
1. 拍卖人上传物品
2. 房主开始拍卖
3. 竞拍者1出价 ¥120
4. 竞拍者2出价 ¥150
5. 竞拍者1再次出价 ¥180
6. 房主结束拍卖

## 🧪 测试步骤

### 测试1：权限验证

1. 点击"切换用户"，选择"观众小明"
2. 点击"出价 ¥110"
3. **预期：** 弹窗提示"❌ 观众无法出价，请升级为竞拍者"
4. 查看控制台日志，应该看到权限检查记录

### 测试2：状态流转

1. 点击"切换用户"，选择"主持人小王"
2. 点击"拍卖人上传物品"
3. **预期：** 弹窗提示"❌ 只有拍卖人可以上传物品"（因为当前是房主）
4. 切换到"拍卖人老李"
5. 再次点击"上传物品"
6. **预期：** 成功上传，消息区显示"📦 新的拍卖品"

### 测试3：完整流程

1. 点击"场景3：完整拍卖流程"
2. **预期：** 自动执行整个流程，观察：
   - 状态从"准备中" → "上拍中" → "拍卖中" → "已定拍"
   - 价格从 ¥100 → ¥120 → ¥150 → ¥180
   - 消息区显示所有出价记录
   - 最终显示成交信息

## 🎯 关键设计亮点

### 1. 权限与状态解耦

```swift
// 权限检查（权限中心负责）
let result = permissionCenter.checkPermission(
    action: .placeBid,
    user: user,
    room: room,
    metadata: ["amount": amount]
)

// 业务执行（状态对象负责）
if result.isAllowed {
    room.stateObject.placeBid(room: room, user: user, amount: amount)
}
```

### 2. 规则引擎灵活性

```swift
// 添加新规则非常简单
addRule(PermissionRule(
    action: .placeBid,
    priority: 70,
    description: "出价金额必须满足要求"
) { context in
    // 自定义验证逻辑
    guard amount >= minValidPrice else {
        return .denied(reason: "❌ 出价至少为 ¥\(minValidPrice)")
    }
    return .allowed
})
```

### 3. 状态模式清晰性

```swift
// 每个状态类只关注自己的业务逻辑
class AuctioningState: RoomStateProtocol {
    func placeBid(room: Room, user: User, amount: Decimal) -> Bool {
        // 只处理出价逻辑，不关心权限
        let bid = Bid(...)
        room.addBid(bid)
        return true
    }
}
```

## 📊 控制台日志

运行时会在控制台看到详细的日志：

```
🏠 创建房间成功：今晚靓号专场
🔐 权限检查: [拍卖人老李] [上传物品] [准备中] -> ✅ 允许
📢 系统: 📦 新的拍卖品：靓号手机号 13888888888
🔐 权限检查: [主持人小王] [开始拍卖] [准备中] -> ✅ 允许
📢 系统: 房间状态变更为：上拍中
📢 系统: 房间状态变更为：拍卖中
🔐 权限检查: [竞拍者张三] [出价] [拍卖中] -> ✅ 允许
💰 竞拍者张三 出价 ¥120
🔐 权限检查: [观众小明] [出价] [拍卖中] -> ❌ 拒绝 ❌ 观众无法出价，请升级为竞拍者
```

## 🚀 运行项目

1. 打开 `PPRoom.xcodeproj`
2. 选择模拟器（推荐 iPhone 15 Pro）
3. 点击运行（⌘R）
4. 开始测试！

## 💡 扩展建议

如果要继续完善这个demo，可以：

1. **添加实时语音**: 集成 WebRTC
2. **添加麦位UI**: 可视化麦位布局
3. **添加倒计时**: 拍卖中的倒计时动画
4. **添加数据持久化**: 保存拍卖记录
5. **添加网络通信**: 多人实时同步
6. **添加更多规则**: 如保证金、黑名单等

## 📝 总结

这个Demo完整展示了：

✅ **权限中心**: 基于规则引擎的灵活权限管理  
✅ **状态模式**: 清晰的状态流转和业务逻辑分离  
✅ **角色系统**: 不同角色的权限差异化  
✅ **架构设计**: 高内聚、低耦合、易扩展  

---

**作者**: AI Assistant  
**日期**: 2025-11-21  
**版本**: v1.0

