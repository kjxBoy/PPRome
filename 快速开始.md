# 拍拍房 Demo - 快速开始指南 🚀

## 📦 项目说明

这是一个完整的**拍拍房拍卖系统 Demo**，展示了：
- ✅ 权限中心（基于规则引擎）
- ✅ 状态模式（4个拍卖状态）
- ✅ 角色协作（4种用户角色）
- ✅ 完整的UI界面
- ✅ 自动化测试

## 🎯 快速运行

### 方法1：使用Xcode运行（推荐）

1. **打开项目**
   ```bash
   cd /Users/kangjiaxing/Desktop/PPRoom
   open PPRoom.xcodeproj
   ```

2. **选择模拟器**
   - 点击Xcode顶部的设备选择器
   - 选择任意iOS模拟器（推荐 iPhone 15 Pro）

3. **运行项目**
   - 点击运行按钮（⌘R）或菜单 Product → Run
   - 等待编译完成

4. **查看效果**
   - App启动后会看到完整的Demo界面
   - 控制台会自动运行测试并输出结果

### 方法2：查看代码学习

如果模拟器有问题，可以直接查看代码：

1. **核心代码位置**
   ```
   PPRoom/
   ├── Models/              # 📦 模型层
   ├── Permission/          # 🔐 权限中心
   ├── States/              # 🔄 状态模式
   ├── Manager/             # 🎯 房间管理器
   ├── ViewController.swift # 🎨 UI界面
   └── Tests/               # 🧪 测试代码
   ```

2. **推荐阅读顺序**
   - `RoomModels.swift` - 理解核心数据结构
   - `PermissionCenter.swift` - 理解权限系统
   - `RoomStateProtocol.swift` - 理解状态模式
   - `RoomManager.swift` - 理解整体协调
   - `ViewController.swift` - 理解UI交互

## 🎮 Demo功能演示

### 1. 切换用户测试权限

界面上有5个用户按钮：
- **主持人小王**（房主）- 拥有所有权限
- **拍卖人老李**（拍卖人）- 可以上传物品，不能给自己出价
- **竞拍者张三**（竞拍者）- 可以出价竞拍
- **竞拍者李四**（竞拍者）- 可以出价竞拍
- **观众小明**（观众）- 只能观看，不能出价

**操作**：
1. 点击不同的用户按钮切换身份
2. 尝试各种操作，观察权限提示

### 2. 手动操作流程

**完整流程**：
1. 切换到"拍卖人老李"
2. 点击"上传物品"
3. 切换到"主持人小王"
4. 点击"开始拍卖"
5. 等待3秒（自动从"上拍"进入"拍卖中"）
6. 切换到"竞拍者张三"
7. 点击"出价 ¥110"
8. 切换到"竞拍者李四"
9. 点击"出价 ¥150"
10. 切换到"主持人小王"
11. 点击"结束拍卖"

**观察**：
- 房间状态的变化：准备中 → 上拍中 → 拍卖中 → 已定拍
- 价格的变化：¥100 → ¥110 → ¥150
- 消息区的实时更新

### 3. 一键测试场景

点击以下按钮可以快速测试：

**场景1：观众尝试出价**
- 点击"场景1"按钮
- 预期结果：弹窗提示"❌ 观众无法出价，请升级为竞拍者"

**场景2：拍卖人给自己出价**
- 点击"场景2"按钮
- 预期结果：弹窗提示"❌ 您是拍卖人，不能对自己的物品出价"

**场景3：完整拍卖流程（自动）**
- 点击"场景3"按钮
- 系统自动执行完整流程
- 观察整个拍卖过程

## 🔍 理解核心设计

### 权限检查流程

```
用户点击按钮
    ↓
RoomManager 接收操作
    ↓
PermissionCenter 检查权限
    ↓
PermissionRuleEngine 执行规则
    ↓
[允许] → State 执行业务逻辑
[拒绝] → 返回错误提示
```

### 状态转换流程

```
准备阶段 (Preparing)
    ↓ [房主点击"开始拍卖"]
上拍 (Listing)
    ↓ [倒计时3秒后自动转换]
拍卖中 (Auctioning)
    ↓ [房主点击"结束拍卖" 或 无人出价]
定拍 (Closed)
    ↓ [房主可以开启下一轮]
准备阶段 (Preparing)
```

### 权限规则示例

```swift
// 规则：拍卖人不能给自己出价
PermissionRule(
    action: .placeBid,
    priority: 90,
    condition: { context in
        if context.user.role == .auctioneer,
           context.user.id == context.room.currentItem?.auctioneerId {
            return .denied(reason: "❌ 您是拍卖人，不能对自己的物品出价")
        }
        return .allowed
    }
)
```

## 📊 查看测试结果

运行项目后，在Xcode控制台（底部）可以看到：

```
====================================
🧪 开始权限系统测试
====================================

【测试1】观众尝试出价（预期：被拒绝）
----------------------------------------
✅ 测试通过：❌ 观众无法出价，请升级为竞拍者

【测试2】拍卖人给自己出价（预期：被拒绝）
----------------------------------------
✅ 测试通过：❌ 您是拍卖人，不能对自己的物品出价

【测试3】完整拍卖流程
----------------------------------------
1️⃣ 拍卖人上传物品...
✅ 上传成功

2️⃣ 房主开始拍卖...
✅ 开始成功

3️⃣ 竞拍者1出价 ¥120...
✅ 出价成功，当前价格：¥120

4️⃣ 竞拍者2出价 ¥150...
✅ 出价成功，当前价格：¥150

5️⃣ 竞拍者1再次出价 ¥180...
✅ 出价成功，当前价格：¥180

6️⃣ 房主结束拍卖...
✅ 拍卖结束
🎉 最终成交：竞拍者张三 - ¥180

✅ 完整流程测试通过！

====================================
✅ 所有测试完成！
====================================
```

## 💡 关键代码位置

### 查看权限规则定义
打开 `PPRoom/Permission/PermissionCenter.swift`
找到 `setupRules()` 方法

### 查看状态转换逻辑
打开 `PPRoom/States/RoomStateProtocol.swift`
查看4个状态类的实现

### 查看完整业务流程
打开 `PPRoom/Manager/RoomManager.swift`
查看各个操作方法

### 查看UI交互
打开 `PPRoom/ViewController.swift`
查看按钮点击事件

## 📚 扩展学习

### 想添加新功能？

1. **添加新角色** → 修改 `UserRole` 枚举
2. **添加新操作** → 修改 `RoomAction` 枚举
3. **添加新规则** → 在 `PermissionCenter` 添加 `PermissionRule`
4. **添加新状态** → 创建新的状态类实现 `RoomStateProtocol`

### 想了解设计细节？

查看文档：
- `拍拍房产品文档.md` - 产品需求和设计
- `README_DEMO.md` - 详细的Demo说明
- `项目总结.md` - 架构设计和总结

## ❓ 常见问题

### Q1: 为什么点击"开始拍卖"后没反应？
**A**: 需要先上传拍卖物品。请：
1. 切换到"拍卖人"
2. 点击"上传物品"
3. 再切换到"房主"
4. 点击"开始拍卖"

### Q2: 为什么出价总是失败？
**A**: 检查以下几点：
1. 是否在"拍卖中"状态？
2. 当前用户是否是"竞拍者"？
3. 出价金额是否足够（至少比当前价高10元）？
4. 如果是拍卖人，不能给自己出价

### Q3: 如何查看详细的权限检查日志？
**A**: 在Xcode控制台（⌘⇧Y）可以看到每次操作的权限检查日志，格式如：
```
🔐 权限检查: [用户名] [操作] [状态] -> ✅ 允许 / ❌ 拒绝 [原因]
```

### Q4: 代码编译失败怎么办？
**A**: 
1. 确保使用的是Xcode 14+
2. 确保iOS Deployment Target是iOS 14+
3. 清理构建（⌘⇧K）后重新构建

## 🎉 开始探索吧！

现在你可以：
1. ✅ 运行项目查看效果
2. ✅ 阅读代码理解设计
3. ✅ 测试各种场景
4. ✅ 修改代码进行实验
5. ✅ 扩展新功能

祝你学习愉快！🚀

---

**有问题？** 查看详细文档或代码注释  
**想深入？** 阅读 `项目总结.md` 了解架构设计

